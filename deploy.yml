- name: Deploy web container remotely
  hosts: remote
  become: true
  tasks:

    - name: Ensure apt packages are up to date
      apt:
        update_cache: yes

    - name: Install required dependencies
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
        state: present

    - name: Add Docker GPG key
      shell: curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

    - name: Add Docker repository
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable
        state: present

    - name: Install Docker
      apt:
        name: docker-ce
        state: present
        update_cache: yes

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Stop existing container (if running)
      shell: docker stop webcontainer || true

    - name: Remove old container (if exists)
      shell: docker rm webcontainer || true

    - name: Copy application files to remote server
      copy:
        src: ./Web/
        dest: /home/azureuser/Web/
    
    - name: Copy Dockerfile to remote server
      copy:
        src: ./Dockerfile
        dest: /home/azureuser/Dockerfile

    - name: Build Docker image on remote
      shell: docker build -t webimage:latest /home/azureuser/

    - name: Run new web container
      shell: docker run -d --name webcontainer -p 8081:80 webimage:latest
